import React, { useState, useEffect } from 'react';
import { GunlukGorevIconSmall } from './IconComponents';
import { getUserDailyBestScore, saveDailyScore } from '../utils/scoreManager.js';

const DIFFICULTY_SETTINGS = {
  easy: { timer: 50, tries: 5, hints: 3, points: 100, emojiCount: 3, timePenalty: 5 },
  medium: { timer: 40, tries: 3, hints: 2, points: 150, emojiCount: 4, timePenalty: 10 },
  hard: { timer: 30, tries: 2, hints: 1, points: 200, emojiCount: 5, timePenalty: 15 }
};

const dailyStories = {
  easy: [
    { emojis: 'üë¥üê±üìö', answer: 'Ya≈ülƒ± adam kedisiyle birlikte kitap okudu.', hint: 'Kedi, ya≈ülƒ± adam, kitap.' },
    { emojis: 'üöÄüßëüåï', answer: 'ƒ∞nsan roketle aya gitti.', hint: 'Roket, insan, ay.' },
    { emojis: 'üê∂üé©üé™', answer: 'K√∂pek sirkte ≈üapka takarak g√∂steri yaptƒ±.', hint: 'K√∂pek, ≈üapka, sirk.' },
    { emojis: 'üë®‚Äçüç≥üçïüî•', answer: 'A≈ü√ßƒ± fƒ±rƒ±nda pizza pi≈üirdi.', hint: 'A≈ü√ßƒ±, pizza, fƒ±rƒ±n.' },
    { emojis: 'üßô‚Äç‚ôÇÔ∏è‚ú®üê∏üëë', answer: 'B√ºy√ºc√º kurbaƒüayƒ± sihirle prense d√∂n√º≈üt√ºrd√º.', hint: 'B√ºy√ºc√º, sihir, kurbaƒüa, prens.' },
    { emojis: 'üë©‚Äçüé§üé§üé∂', answer: '≈ûarkƒ±cƒ± sahnede ≈üarkƒ± s√∂yledi.', hint: '≈ûarkƒ±cƒ±, sahne, m√ºzik.' },
    { emojis: 'ü¶Åüë¶üå≥', answer: '√áocuk ormanda aslanla kar≈üƒ±la≈ütƒ±.', hint: '√áocuk, orman, aslan.' },
    { emojis: 'üë®‚Äçüöíüî•üè†', answer: 'ƒ∞tfaiyeci evdeki yangƒ±nƒ± s√∂nd√ºrd√º.', hint: 'ƒ∞tfaiyeci, yangƒ±n, ev.' },
    { emojis: 'ü¶Ñüåàüëß', answer: 'K√º√ß√ºk kƒ±z g√∂kku≈üaƒüƒ±nda unicorn g√∂rd√º.', hint: 'Kƒ±z, g√∂kku≈üaƒüƒ±, unicorn.' },
    { emojis: 'üë®‚Äçüåæüåæüöú', answer: '√áift√ßi trakt√∂rle buƒüday ekti.', hint: '√áift√ßi, buƒüday, trakt√∂r.' },
    { emojis: 'üë¶‚ùÑÔ∏èüéø', answer: '√áocuk karda kayak yaptƒ±.', hint: '√áocuk, kar, kayak.' },
    { emojis: 'ü¶äüçáüå≤', answer: 'Tilki ormanda √ºz√ºm buldu.', hint: 'Tilki, orman, √ºz√ºm.' },
    { emojis: 'üë®‚Äçüé®üé®üñºÔ∏è', answer: 'Ressam g√ºzel bir tablo yaptƒ±.', hint: 'Ressam, tablo, boya.' },
    { emojis: 'üë©‚Äçüè´üìöüìù', answer: '√ñƒüretmen √∂ƒürencilere ders anlattƒ±.', hint: '√ñƒüretmen, ders, kitap.' }
  ],
  medium: [
    { emojis: 'üçïüçÖüßÄ', answer: 'Pizza domates ve peynir ile yapƒ±lƒ±r.', hint: 'Pizza, domates, peynir.' },
    { emojis: 'üë®‚Äçüíºüöó‚õΩÔ∏èüèÅ', answer: 'Adam arabasƒ±na benzin aldƒ± ve yarƒ±≈üa katƒ±ldƒ±.', hint: 'Adam, araba, benzin, yarƒ±≈ü.' },
    { emojis: 'üåßÔ∏èüåûüåà', answer: 'Yaƒümur yaƒüdƒ±, g√ºne≈ü a√ßtƒ±, g√∂kku≈üaƒüƒ± olu≈ütu.', hint: 'Yaƒümur, g√ºne≈ü, g√∂kku≈üaƒüƒ±.' },
    { emojis: 'üë∏üêâüè∞‚öîÔ∏è', answer: 'Prenses ejderhayƒ± yendi ve kaleyi kurtardƒ±.', hint: 'Prenses, ejderha, kale.' },
    { emojis: 'üë®‚Äçüè´üìöüë¶üëß', answer: '√ñƒüretmen √∂ƒürencilere yeni konular anlattƒ±.', hint: '√ñƒüretmen, ders, √∂ƒürenciler.' },
    { emojis: 'üë©‚Äçüåæüçìüçíüçá', answer: 'Kadƒ±n √ßift√ßi meyve topladƒ±.', hint: '√áift√ßi, meyve, toplamak.' },
    { emojis: 'üëßüèä‚Äç‚ôÄÔ∏èüèÖüéâ', answer: 'K√º√ß√ºk kƒ±z y√ºzme yarƒ±≈üƒ±nda √∂d√ºl kazandƒ± ve √ßok sevindi.', hint: 'Kƒ±z, y√ºzme, √∂d√ºl, sevin√ß.' },
    { emojis: 'üë¶üß©üé≤üß†', answer: '√áocuk zeka oyunlarƒ± oynayarak beynini geli≈ütirdi.', hint: '√áocuk, zeka, oyun, beyin.' },
    { emojis: 'üë©‚Äçüé®üé®üñåÔ∏èüñºÔ∏è', answer: 'Kadƒ±n ressam tablo yaptƒ±.', hint: 'Ressam, tablo, boya.' },
    { emojis: 'üë®‚Äçüîßüî©üîßüöó', answer: 'Tamirci arabayƒ± tamir etti.', hint: 'Tamirci, araba, tamir.' },
    { emojis: 'üë©‚Äçüç≥üç≥ü•òüçΩÔ∏è', answer: 'A≈ü√ßƒ± yemek pi≈üirdi ve servis etti.', hint: 'A≈ü√ßƒ±, yemek, pi≈üirme, servis.' },
    { emojis: 'üë®‚Äç‚öïÔ∏èüè•üíäüëµ', answer: 'Doktor hastanede ya≈ülƒ± kadƒ±na ila√ß verdi.', hint: 'Doktor, hastane, ila√ß, ya≈ülƒ±.' },
    { emojis: 'üë®‚Äçüöíüî•üöíüè†', answer: 'ƒ∞tfaiyeci yangƒ±n aracƒ±yla evdeki yangƒ±nƒ± s√∂nd√ºrd√º.', hint: 'ƒ∞tfaiyeci, yangƒ±n, ara√ß, ev.' },
    { emojis: 'üë®‚Äçüåæüåæüå±üöú', answer: '√áift√ßi trakt√∂rle buƒüday ekti.', hint: '√áift√ßi, buƒüday, ekim, trakt√∂r.' }
  ],
  hard: [
    { emojis: 'ü¶∏‚Äç‚ôÇÔ∏èüöóüí•üè•üë®‚Äç‚öïÔ∏è', answer: 'S√ºper kahraman araba kazasƒ±nƒ± √∂nledi ve hastaneye g√∂t√ºrd√º.', hint: 'Kahraman, kaza, hastane.' },
    { emojis: 'üë∏üêâüè∞‚öîÔ∏èüèÜ', answer: 'Prenses ejderhayƒ± yendi, kaleyi kurtardƒ± ve √∂d√ºl kazandƒ±.', hint: 'Prenses, ejderha, kale, √∂d√ºl.' },
    { emojis: 'üë®‚Äçüè´üìöüë¶üëßüéì', answer: '√ñƒüretmen √∂ƒürencilere yeni konular anlattƒ± ve mezuniyet yaptƒ±.', hint: '√ñƒüretmen, ders, √∂ƒürenciler, mezuniyet.' },
    { emojis: 'üë©‚Äçüåæüçìüçíüçáüå±', answer: 'Kadƒ±n √ßift√ßi meyve topladƒ± ve yeni bitkiler ekti.', hint: '√áift√ßi, meyve, toplamak, bitki.' },
    { emojis: 'üëßüèä‚Äç‚ôÄÔ∏èüèÖüéâüåü', answer: 'K√º√ß√ºk kƒ±z y√ºzme yarƒ±≈üƒ±nda √∂d√ºl kazandƒ±, sevindi ve parladƒ±.', hint: 'Kƒ±z, y√ºzme, √∂d√ºl, sevin√ß, parƒ±ltƒ±.' },
    { emojis: 'üë¶üß©üé≤üß†ü§î', answer: '√áocuk zeka oyunlarƒ± oynayarak beynini geli≈ütirdi ve d√º≈ü√ºnd√º.', hint: '√áocuk, zeka, oyun, beyin, d√º≈ü√ºnme.' },
    { emojis: 'üë©‚Äçüé®üé®üñåÔ∏èüñºÔ∏èüòå', answer: 'Kadƒ±n ressam tablo yaptƒ± ve huzurlu hissetti.', hint: 'Ressam, tablo, boya, huzur.' },
    { emojis: 'üë®‚Äçüî¨üß™üî¨üèÜüéä', answer: 'Bilim insanƒ± deney yaptƒ±, √∂d√ºl kazandƒ± ve kutladƒ±.', hint: 'Bilim, deney, √∂d√ºl, kutlama.' },
    { emojis: 'üëßüö¥‚Äç‚ôÄÔ∏èüå≥üòÑüéØ', answer: 'K√º√ß√ºk kƒ±z bisikletle parka gitti, g√ºld√º ve hedefe ula≈ütƒ±.', hint: 'Kƒ±z, bisiklet, park, g√ºlme, hedef.' },
    { emojis: 'üë¶‚öΩÔ∏èü•ÖüèÖüî•', answer: '√áocuk futbol oynadƒ±, gol atarak √∂d√ºl kazandƒ± ve heyecanlandƒ±.', hint: '√áocuk, futbol, gol, √∂d√ºl, heyecan.' },
    { emojis: 'üë©‚ÄçüöÄüöÄüåïüèÖüåü', answer: 'Kadƒ±n astronot aya gitti, √∂d√ºl aldƒ± ve yƒ±ldƒ±z gibi parladƒ±.', hint: 'Astronot, ay, √∂d√ºl, yƒ±ldƒ±z.' },
    { emojis: 'üë¶üß©üß†üéØüéØ', answer: '√áocuk zeka oyunu oynayarak hedefe ula≈ütƒ± ve ba≈üardƒ±.', hint: '√áocuk, zeka oyunu, hedef, ba≈üarƒ±.' },
    { emojis: 'üë©‚ÄçüåæüçÖü•íü•óüå±', answer: 'Kadƒ±n √ßift√ßi sebze yeti≈ütirip salata yaptƒ± ve b√ºy√ºd√º.', hint: '√áift√ßi, sebze, salata, b√ºy√ºme.' }
  ]
};

function getTodayKey() {
  return new Date().toISOString().split('T')[0];
}

function DailyChallenge({ currentUserEmail, currentUserName, onFinish, difficulty = 'easy' }) {
  const [currentStoryIndex, setCurrentStoryIndex] = useState(0);
  const [currentStory, setCurrentStory] = useState(null);
  const [guess, setGuess] = useState('');
  const [score, setScore] = useState(0);
  const [timer, setTimer] = useState(() => DIFFICULTY_SETTINGS[difficulty].timer);
  const [tries, setTries] = useState(0);
  const [finished, setFinished] = useState(false);
  const [showHint, setShowHint] = useState(false);
  const [hintLevel, setHintLevel] = useState(0);
  const [correctAnswers, setCorrectAnswers] = useState(0); // Doƒüru cevap sayƒ±sƒ±
  const [showPopup, setShowPopup] = useState(false);
  const [popupMessage, setPopupMessage] = useState('');
  const [popupType, setPopupType] = useState('correct');
  const [usedStories, setUsedStories] = useState([]);
  const settings = DIFFICULTY_SETTINGS[difficulty];
  const MAX_HINTS = settings.hints;

  // Difficulty deƒüi≈ütiƒüinde currentStory'yi g√ºncelle
  useEffect(() => {
    console.log('Difficulty changed useEffect:', { difficulty, dailyStories: dailyStories[difficulty] });
    
    // Kullanƒ±lmamƒ±≈ü hikayeleri filtrele
    const availableStories = dailyStories[difficulty].filter(story => 
      !usedStories.some(used => used.emojis === story.emojis)
    );
    
    // Eƒüer t√ºm hikayeler kullanƒ±ldƒ±ysa, listeyi sƒ±fƒ±rla
    if (availableStories.length === 0) {
      setUsedStories([]);
      const randomIndex = Math.floor(Math.random() * dailyStories[difficulty].length);
      const newStory = dailyStories[difficulty][randomIndex];
      setCurrentStory(newStory);
      setUsedStories([newStory]);
    } else {
      // Kullanƒ±lmamƒ±≈ü hikayelerden rastgele se√ß
      const randomIndex = Math.floor(Math.random() * availableStories.length);
      const newStory = availableStories[randomIndex];
      setCurrentStory(newStory);
      setUsedStories(prev => [...prev, newStory]);
    }
    
    setTimer(DIFFICULTY_SETTINGS[difficulty].timer);
    setTries(0);
    setFinished(false);
    setShowHint(false);
    setHintLevel(0);
    setScore(0);
    setGuess('');
  }, [difficulty]);

  useEffect(() => {
    console.log('Timer useEffect:', { timer, finished, currentStory });
    if (timer > 0 && !finished) {
      const interval = setInterval(() => {
        setTimer(prev => prev - 1);
      }, 1000);
      return () => clearInterval(interval);
    } else if (timer === 0 && !finished) {
      console.log('Timer 0, checking if next round or game over');
      // Timer 0 - sonraki tura ge√ß veya oyun bitti
      if (currentStoryIndex < 2) { // 3 tur var (0, 1, 2)
        console.log('Moving to next round');
        setCurrentStoryIndex(prev => prev + 1);
        
        // Kullanƒ±lmamƒ±≈ü hikayeleri filtrele
        const availableStories = dailyStories[difficulty].filter(story => 
          !usedStories.some(used => used.emojis === story.emojis)
        );
        
        // Eƒüer t√ºm hikayeler kullanƒ±ldƒ±ysa, listeyi sƒ±fƒ±rla
        if (availableStories.length === 0) {
          setUsedStories([]);
          const randomIndex = Math.floor(Math.random() * dailyStories[difficulty].length);
          const nextStory = dailyStories[difficulty][randomIndex];
          setCurrentStory(nextStory);
          setUsedStories([nextStory]);
        } else {
          // Kullanƒ±lmamƒ±≈ü hikayelerden rastgele se√ß
          const randomIndex = Math.floor(Math.random() * availableStories.length);
          const nextStory = availableStories[randomIndex];
          setCurrentStory(nextStory);
          setUsedStories(prev => [...prev, nextStory]);
        }
        setTimer(DIFFICULTY_SETTINGS[difficulty].timer);
        setTries(0);
        setShowHint(false);
        setHintLevel(0);
        setGuess('');
      } else {
        // Son turda s√ºre bitti - oyun bitti
        console.log('Last round, calling handleGameOver');
        handleGameOver();
      }
    }
  }, [timer, finished, currentStory]);

  const checkGuess = (userGuess, story) => {
    const cleanGuess = userGuess.toLowerCase().trim();
    const cleanAnswer = story.answer.toLowerCase();
    
    if (cleanGuess === cleanAnswer) return true;
    
    const guessWords = cleanGuess.split(' ');
    const answerWords = cleanAnswer.split(' ');
    
    const matchingWords = guessWords.filter(word => 
      answerWords.some(answerWord => answerWord.includes(word) || word.includes(answerWord))
    );
    
    return matchingWords.length >= Math.max(guessWords.length * 0.7, 2);
  };

  const handleGuess = () => {
    if (!guess.trim() || !currentStory) return;

    const storyToCheck = currentStory;
    const isCorrect = checkGuess(guess, storyToCheck);
    
    if (isCorrect) {
      // Doƒüru cevap sayƒ±sƒ±nƒ± artƒ±r
      setCorrectAnswers(prev => prev + 1);
      
      // G√ºnl√ºk G√∂rev Puanlama Sistemi
      let basePoints = 0;
      if (difficulty === 'easy') basePoints = 5;
      else if (difficulty === 'medium') basePoints = 10;
      else if (difficulty === 'hard') basePoints = 15;
      
      // S√ºre bonusu
      let timeBonus = 0;
      if (timer >= 20) timeBonus = 2; // 20+ saniye kaldƒ±ysa +2
      else if (timer >= 10) timeBonus = 1; // 10+ saniye kaldƒ±ysa +1
      
      // Kalan hak bonusu
      const remainingTriesBonus = (settings.tries - tries) * 1; // Her kalan hak +1
      
      const roundScore = basePoints + timeBonus + remainingTriesBonus;
      
      setScore(prev => prev + roundScore);
      
      // Popup mesajƒ± g√∂ster
      setPopupMessage(`Doƒüru! +${roundScore} puan üéâ`);
      setPopupType('correct');
      setShowPopup(true);
      
      // 1.5 saniye sonra popup'ƒ± kapat ve sonraki soruya ge√ß
      setTimeout(() => {
        setShowPopup(false);
        
        // Doƒüru tahmin - sonraki tura ge√ß
        if (currentStoryIndex < 2) { // 3 tur var (0, 1, 2)
          setCurrentStoryIndex(prev => prev + 1);
          
          // Rastgele yeni hikaye se√ß
          const availableStories = dailyStories[difficulty];
          const randomIndex = Math.floor(Math.random() * availableStories.length);
          const nextStory = availableStories[randomIndex];
          
          setCurrentStory(nextStory);
          setTimer(DIFFICULTY_SETTINGS[difficulty].timer);
          setTries(0);
          setShowHint(false);
          setHintLevel(0);
          setGuess('');
        } else {
          // Son tur tamamlandƒ±
          setFinished(true);
        }
      }, 2000);
    } else {
      setTries(prev => prev + 1); // Kullanƒ±lan deneme sayƒ±sƒ±nƒ± artƒ±r
      
      // Yanlƒ±≈ü cevap popup mesajƒ±
      const remainingTries = DIFFICULTY_SETTINGS[difficulty].tries - tries - 1;
      if (remainingTries > 0) {
        setPopupMessage(`Yanlƒ±≈ü! Kalan: ${remainingTries}`);
        setPopupType('warning');
        setShowPopup(true);
        
        setTimeout(() => {
          setShowPopup(false);
        }, 1500);
      } else {
        // Hak bitti popup mesajƒ±
        setPopupMessage('Hak bitti! üîÑ');
        setPopupType('warning');
        setShowPopup(true);
        
        setTimeout(() => {
          setShowPopup(false);
          
          // Hak bitti - sonraki tura ge√ß veya oyun bitti
          if (currentStoryIndex < 2) { // 3 tur var (0, 1, 2)
            setCurrentStoryIndex(prev => prev + 1);
            
            // Rastgele yeni hikaye se√ß
            const availableStories = dailyStories[difficulty];
            const randomIndex = Math.floor(Math.random() * availableStories.length);
            const nextStory = availableStories[randomIndex];
            
            setCurrentStory(nextStory);
            setTimer(DIFFICULTY_SETTINGS[difficulty].timer);
            setTries(0);
            setShowHint(false);
            setHintLevel(0);
            setGuess('');
          } else {
            // Son turda hak bitti - oyun bitti
            handleGameOver();
          }
        }, 1500);
      }
    }
    setGuess('');
  };

  const handleGameOver = () => {
    setFinished(true);
    setTimer(0);
  };

  const handleRestart = () => {
    function getDiverseStories(count = 3) {
      const availableStories = dailyStories[difficulty];
      const shuffled = [...availableStories].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, count);
    }
    
    // ƒ∞lk hikayeyi rastgele se√ß
    const randomIndex = Math.floor(Math.random() * dailyStories[difficulty].length);
    const selectedStory = dailyStories[difficulty][randomIndex];
    
    setCurrentStory(selectedStory);
    setCurrentStoryIndex(0);
    setGuess('');
    setScore(0);
    setTimer(settings.timer);
    setTries(0);
    setFinished(false);
    setShowHint(false);
    setHintLevel(0);
    setCorrectAnswers(0); // Doƒüru cevap sayƒ±sƒ±nƒ± sƒ±fƒ±rla
    setShowPopup(false);
    setPopupMessage('');
    setPopupType('correct');
    setUsedStories([]);
  };

  const handleFinish = () => {
    if (finished && score > 0) {
      // T√ºm g√∂revleri bitirme bonusu
      let finalScore = score;
      if (correctAnswers === 3) {
        finalScore += 5; // T√ºm g√∂revleri bitirirse +5 bonus
        console.log('T√ºm g√∂revler tamamlandƒ±! +5 bonus puan');
      }
      
      const todayKey = getTodayKey();
      saveDailyScore(currentUserEmail, currentUserName || 'Kullanƒ±cƒ±', finalScore);
      onFinish(finalScore);
    } else {
      onFinish(score);
    }
  };

  const getSmartHint = (level) => {
    if (!currentStory) return '';
    
    const hints = currentStory.hint.split(', ');
    if (level <= hints.length) {
      return hints[level - 1];
    }
    return hints[hints.length - 1];
  };

  const getHintText = () => {
    if (hintLevel === 0) return '';
    const hintContent = getSmartHint(hintLevel);
    if (difficulty === 'hard') {
      return `ƒ∞pucu: ${hintContent}`;
    } else {
      return `ƒ∞pucu ${hintLevel}: ${hintContent}`;
    }
  };

  const handleHint = () => {
    if (hintLevel < MAX_HINTS) {
      setHintLevel(prev => prev + 1);
      setShowHint(true);
    }
  };

  if (finished) {
    const successRate = Math.round((correctAnswers / 3) * 100);
    const averageScore = Math.round(score / 3);
    // Yeni mantƒ±klƒ± yƒ±ldƒ±z sistemi
    let stars = 0;
    if (correctAnswers === 3) {
      stars = 5; // 3/3 doƒüru = 5 yƒ±ldƒ±z
    } else if (correctAnswers === 2) {
      stars = 3; // 2/3 doƒüru = 3 yƒ±ldƒ±z
    } else if (correctAnswers === 1) {
      stars = 1; // 1/3 doƒüru = 1 yƒ±ldƒ±z
    } else {
      stars = 0; // 0/3 doƒüru = 0 yƒ±ldƒ±z
    }

  return (
      <div style={{
        minHeight: '100vh',
        background: 'linear-gradient(to bottom right, #f0f4ff, #ffffff)',
        padding: '20px',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center'
      }}>

        {/* Game Over Kartƒ± */}
        <div style={{
          background: '#fff',
          borderRadius: 20,
          padding: '32px',
          boxShadow: '0 6px 16px rgba(0, 0, 0, 0.08), 0 12px 32px rgba(0, 0, 0, 0.12)',
          maxWidth: 500,
          width: '100%',
          textAlign: 'center',
          border: '1px solid rgba(255, 255, 255, 0.8)',
          position: 'relative'
        }}>
          {/* Ana Men√º Butonu - Kartƒ±n i√ßinde saƒü √ºst k√∂≈üe */}
          <div style={{
            position: 'absolute',
            top: 20,
            right: 20,
            zIndex: 10
          }}>
            <button 
              onClick={handleFinish}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 6,
                padding: '8px 16px',
                fontSize: '0.9rem',
                borderRadius: 10,
                background: '#f8fafc',
                color: '#374151',
                fontWeight: 600,
                border: '1px solid #e2e8f0',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                boxShadow: '0 2px 6px rgba(0, 0, 0, 0.04)',
                maxWidth: 'fit-content',
                whiteSpace: 'nowrap'
              }}
              onMouseOver={e => {
                e.currentTarget.style.background = '#ffffff';
                e.currentTarget.style.borderColor = '#cbd5e1';
                e.currentTarget.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.08)';
              }}
              onMouseOut={e => {
                e.currentTarget.style.background = '#f8fafc';
                e.currentTarget.style.borderColor = '#e2e8f0';
                e.currentTarget.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.04)';
              }}
            >
              <span style={{ fontSize: '0.9rem' }}>üè†</span>
              Ana Men√º
            </button>
          </div>
          <h1 style={{
            fontSize: '28px',
            fontWeight: 700,
            fontFamily: 'Poppins, sans-serif',
            background: 'linear-gradient(to right, #ff6a6a, #ffb347)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            margin: '0 0 8px 0',
            textAlign: 'center'
          }}>
            Oyun Bitti!
          </h1>
          
          <p style={{ 
            fontSize: '1rem', 
            color: '#6b7280', 
            margin: '0 0 24px 0' 
          }}>
            Harika bir deneme! Bir kez daha ≈üansƒ±nƒ± denemek ister misin?
          </p>
          
          {/* Skor Kartƒ± */}
          <div style={{
            background: '#fff',
            borderRadius: 16,
            padding: '24px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.06), 0 8px 24px rgba(0, 0, 0, 0.1)',
            marginBottom: 24,
            border: '1px solid rgba(0, 0, 0, 0.08)'
          }}>
            {/* Toplam Skor */}
            <div style={{ marginBottom: 20 }}>
              <div style={{ fontSize: '3rem', marginBottom: 8 }}>üèÜ</div>
              <div style={{ fontSize: '2.5rem', fontWeight: 800, color: '#1f2937', marginBottom: 4 }}>
                {score}
              </div>
              <div style={{ fontSize: '1rem', color: '#6b7280', fontWeight: 600 }}>
                TOPLAM SKOR
            </div>
            </div>
            
            {/* Performans Metrikleri */}
                <div style={{ 
                  display: 'flex', 
              justifyContent: 'space-around', 
              marginBottom: 16,
              fontSize: '0.9rem'
            }}>
              <div>
                <div style={{ color: '#6b7280', marginBottom: 4 }}>Doƒüru Cevap</div>
                <div style={{ fontWeight: 700, color: '#1f2937' }}>{correctAnswers}/3</div>
              </div>
              <div>
                <div style={{ color: '#6b7280', marginBottom: 4 }}>Ba≈üarƒ± Oranƒ±</div>
                <div style={{ fontWeight: 700, color: '#1f2937' }}>{successRate}%</div>
              </div>
            </div>
            
            {/* Ortalama Skor */}
                  <div style={{ 
              fontSize: '0.8rem', 
              color: '#9ca3af', 
              marginBottom: 12 
            }}>
              Ortalama: {averageScore} puan/tur
                  </div>
            
            {/* Motivasyon Mesajƒ± */}
                  <div style={{ 
                    fontSize: '1.1rem', 
              fontWeight: 600, 
              color: correctAnswers === 3 ? '#10b981' : '#f59e0b',
              padding: '8px 16px',
              background: correctAnswers === 3 ? '#d1fae5' : '#fef3c7',
              borderRadius: 8,
              display: 'inline-block'
            }}>
              {correctAnswers === 3 ? 'M√ºkemmel! T√ºm sorularƒ± doƒüru bildin! üéâ' : 
               correctAnswers === 2 ? '√áok iyi! Neredeyse tamamladƒ±n! üí™' :
               correctAnswers === 1 ? 'ƒ∞yi deneme! Biraz daha √ßalƒ±≈ü! üí™' : 
               'Daha iyisini yapabilirsin! üí™'}
                  </div>
          </div>
          
          {/* Yƒ±ldƒ±zlar - Sadece doƒüru cevap varsa g√∂ster */}
          {stars > 0 ? (
              <div style={{ 
                display: 'flex', 
              justifyContent: 'center', 
              gap: 8, 
              marginBottom: 24 
            }}>
              {[1, 2, 3, 4, 5].map((star) => (
                <span key={star} style={{ 
                  fontSize: '1.5rem',
                  color: star <= stars ? '#fbbf24' : '#d1d5db'
                }}>
                  {star <= stars ? '‚≠ê' : '‚òÜ'}
                </span>
              ))}
            </div>
          ) : (
            <div style={{ 
              textAlign: 'center', 
              marginBottom: 24,
              padding: '12px 20px',
              background: '#fef3c7',
              borderRadius: 12,
                                border: '2px solid var(--secondary)'
            }}>
              <div style={{ 
                fontSize: '1.1rem', 
                fontWeight: 600, 
                color: '#92400e',
                marginBottom: 4
              }}>
                ‚≠ê Yƒ±ldƒ±z Kazanamadƒ±n
              </div>
              <div style={{ 
                fontSize: '0.9rem', 
                color: '#a16207'
              }}>
                Bu oyunda yƒ±ldƒ±z kazanamadƒ±n, tekrar dene!
              </div>
            </div>
          )}
          
          {/* Tekrar Oyna Butonu */}
            <button 
              onClick={handleRestart} 
              style={{ 
              background: 'linear-gradient(to right, #ff6a6a, #ffb347)',
                color: '#fff', 
                border: 'none',
              borderRadius: 12,
              padding: '12px 20px',
              fontSize: '1.1rem',
              fontWeight: 600,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              margin: '0 auto',
              boxShadow: '0 4px 12px rgba(255, 106, 106, 0.3)',
              transition: 'all 0.2s ease'
            }}
          >
            <span style={{ fontSize: '1.2rem' }}>üîÑ</span>
            Tekrar Oyna
          </button>
        </div>
      </div>
    );
  }

  return (
            <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(to bottom right, #f0f4ff, #ffffff)',
          padding: '20px',
          display: 'flex', 
          justifyContent: 'center', 
          alignItems: 'center'
        }}>
      {/* Ana Oyun Kartƒ± */}
      <div style={{
        background: '#fff',
        borderRadius: 20,
          padding: '36px',
          boxShadow: '0 6px 16px rgba(0, 0, 0, 0.08), 0 12px 32px rgba(0, 0, 0, 0.12)',
        maxWidth: 600,
        width: '100%',
          position: 'relative',
          border: '1px solid rgba(255, 255, 255, 0.8)'
      }}>
        {/* Ana Men√º Butonu - Kartƒ±n i√ßinde saƒü √ºst k√∂≈üe */}
        <div style={{
          position: 'absolute',
          top: 20,
          right: 20,
          zIndex: 10
        }}>
          <button 
            onClick={handleFinish}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: 6,
              padding: '8px 16px',
              fontSize: '0.9rem',
              borderRadius: 10,
              background: '#f8fafc',
              color: '#374151',
              fontWeight: 600,
              border: '1px solid #e2e8f0',
                cursor: 'pointer',
              transition: 'all 0.2s ease',
              boxShadow: '0 2px 6px rgba(0, 0, 0, 0.04)',
              maxWidth: 'fit-content',
              whiteSpace: 'nowrap'
              }}
              onMouseOver={e => {
                              e.currentTarget.style.background = '#ffffff';
              e.currentTarget.style.borderColor = '#cbd5e1';
              e.currentTarget.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.08)';
              }}
              onMouseOut={e => {
              e.currentTarget.style.background = '#f8fafc';
                              e.currentTarget.style.borderColor = '#e2e8f0';
                e.currentTarget.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.04)';
              }}
            >
            <span style={{ fontSize: '0.9rem' }}>üè†</span>
            Ana Men√º
            </button>
          </div>

        {/* Ba≈ülƒ±k */}
          <div style={{ 
          textAlign: 'center',
          marginBottom: 24,
          marginTop: 20
        }}>
          <h1 style={{
            fontSize: '28px',
            fontWeight: 700,
            fontFamily: 'Poppins, sans-serif',
            background: 'linear-gradient(to right, #ff6a6a, #ffb347)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            margin: '0 0 8px 0',
            textAlign: 'center'
          }}>
            G√ºnl√ºk G√∂rev
          </h1>
        </div>

        {/* √ústte zorluk kutusu - Geli≈ütirilmi≈ü */}
<div className="zorluk-kutusu" style={{
  marginBottom: 28,
  padding: '12px 16px',
  background: 'rgba(248, 250, 252, 0.8)',
  borderRadius: 12,
  border: '1px solid rgba(0, 0, 0, 0.05)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  gap: 16,
  fontSize: '0.95rem',
  fontWeight: 500
}}>
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span className="ikon" style={{color: difficulty === 'easy' ? '#22c55e' : difficulty === 'medium' ? '#eab308' : '#ef4444', fontSize: '0.8rem'}}>‚óè</span>
    <span>Zorluk:</span>
    <span style={{fontWeight: 600, color: '#374151'}}>{difficulty === 'easy' ? 'Kolay' : difficulty === 'medium' ? 'Orta' : 'Zor'}</span>
  </div>
  
  <div style={{ 
    width: '1px', 
    height: '20px', 
    background: 'rgba(0, 0, 0, 0.1)',
    margin: '0 8px'
  }}></div>
  
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span className="ikon" style={{color:'#fbbf24', fontSize: '1rem'}}>üí°</span>
    <span>ƒ∞pucu:</span>
    <span style={{fontWeight: 600, color: '#374151'}}>{hintLevel}/{settings.hints}</span>
  </div>
  
  <div style={{ 
    width: '1px', 
    height: '20px', 
    background: 'rgba(0, 0, 0, 0.1)',
    margin: '0 8px'
  }}></div>
  
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span className="ikon" style={{color:'#0277bd', fontSize: '1rem'}}>üîí</span>
    <span style={{fontWeight: 600, color: '#374151'}}>Otomatik</span>
  </div>
</div>
        {/* Emoji + soru alanƒ± */}
        <div className="emoji-box" style={{marginBottom: 28}}>
          <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 28, marginBottom: 28, minHeight: 80 }}>
            {currentStory && currentStory.emojis ? (
              <span style={{ fontSize: '3.7rem', letterSpacing: '8px' }}>{currentStory.emojis}</span>
            ) : (
              <span style={{ fontSize: '1.5rem', color: '#666' }}>
                {currentStory ? 'Emoji y√ºkleniyor...' : 'Hikaye y√ºkleniyor...'}
              </span>
            )}
          </div>
                      <p style={{ fontSize: '1.25rem', fontWeight: 700, color: 'var(--primary)', textAlign: 'center', margin: 0, lineHeight: 1.4 }}>Bu emojiler hangi hikayeyi anlatƒ±yor?</p>
        </div>
{/* Input ve butonlar alt satƒ±rda */}
<div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
              <input
                type="text"
                value={guess}
    onChange={(e) => setGuess(e.target.value)}
    onKeyPress={(e) => e.key === 'Enter' && handleGuess()}
    placeholder="Hikayeyi tahmin et..."
    style={{ width: '100%', padding: '14px 18px', fontSize: '1.08rem', borderRadius: 14, border: '2px solid #e2e8f0', outline: 'none', background: '#fff', boxShadow: '0 2px 8px rgba(0,0,0,0.04)', transition: 'all 0.2s' }}
                onFocus={e => { e.target.style.borderColor = 'var(--primary)'; }}
    onBlur={e => { e.target.style.borderColor = '#e2e8f0'; }}
  />
  <div style={{ display: 'flex', gap: 12, justifyContent: 'center' }}>
              <button 
      className="button-gradient" 
                onClick={handleGuess}
                  style={{ flex: 1, maxWidth: 200, padding: '12px 20px', fontSize: '1.08rem', borderRadius: 12, background: 'linear-gradient(to right, #ff6a6a, #ffb347)', color: '#fff', border: 'none', fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}
              >
      <span role="img" aria-label="search">üîç</span> Tahmin Et
              </button>
              <button
      className="button-gradient" 
      onClick={handleHint} 
      disabled={hintLevel >= MAX_HINTS} 
                style={{ 
        padding: '12px 20px', 
        fontSize: '1.08rem', 
                  borderRadius: 12, 
        background: '#f8fafc', 
        color: hintLevel < MAX_HINTS ? '#374151' : '#9ca3af', 
                  border: '2px solid #e2e8f0', 
        fontWeight: 600, 
        cursor: hintLevel < MAX_HINTS ? 'pointer' : 'not-allowed', 
        opacity: hintLevel < MAX_HINTS ? 1 : 0.7, 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center', 
        gap: 8,
        minWidth: 120,
        maxWidth: 150,
        transition: 'all 0.2s ease'
      }}
    >
      <span role="img" aria-label="bulb" style={{ color: hintLevel < MAX_HINTS ? '#fbbf24' : '#9ca3af', fontSize: '1.1rem' }}>üí°</span> ƒ∞pucu ({hintLevel}/{settings.hints})
              </button>
            </div>
</div>
{showHint && hintLevel > 0 && (
  <div style={{ 
    margin: '18px auto 0 auto', 
    background: '#4CAF50', 
    color: '#fff', 
    fontWeight: 600, 
    fontSize: '1rem', 
    borderRadius: 12, 
    boxShadow: '0 3px 12px rgba(76, 175, 80, 0.3)', 
    padding: '12px 16px', 
    width: '100%', 
    maxWidth: 340, 
    textAlign: 'center', 
    border: '1px solid #388E3C',
    backdropFilter: 'blur(10px)'
  }}>
    ƒ∞pucu {hintLevel}: {getSmartHint(hintLevel)}
              </div>
            )}

{/* Popup Mesajƒ± */}
{showPopup && (
  <div style={{
    position: 'absolute',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    background: popupType === 'correct' ? '#22c55e' : '#f59e0b',
    color: '#fff',
    padding: '8px 16px',
    borderRadius: 8,
    boxShadow: '0 4px 16px rgba(0, 0, 0, 0.2)',
    zIndex: 1000,
    fontSize: '0.9rem',
    fontWeight: 600,
    textAlign: 'center',
    whiteSpace: 'pre-line',
    border: popupType === 'correct' ? '1px solid #16a34a' : '1px solid #d97706',
    maxWidth: '280px',
    opacity: 0,
    animation: 'popupSlideIn 0.3s ease-out forwards'
  }}>
    {popupMessage}
  </div>
)}
{/* Alt istatistik paneli ve ilerleme √ßubuƒüu */}
<div style={{ 
  marginTop: 24, 
  padding: '14px 20px', 
  background: 'rgba(248, 250, 252, 0.9)', 
  borderRadius: 16, 
  border: '1px solid rgba(0, 0, 0, 0.08)', 
  boxShadow: '0 4px 12px rgba(0, 0, 0, 0.06)', 
  display: 'flex', 
  justifyContent: 'space-between', 
  alignItems: 'center', 
  fontWeight: 600, 
  fontSize: '1rem', 
  color: '#374151', 
  gap: 16,
  backdropFilter: 'blur(10px)'
}}>
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span role="img" aria-label="medal" style={{ fontSize: '1.1rem' }}>üèÖ</span> 
    <span>Skor:</span> <b>{score}</b>
  </div>
  
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span role="img" aria-label="timer" style={{ fontSize: '1.1rem' }}>‚è±Ô∏è</span> 
    <span>S√ºre</span> <span style={{color:'#FF9800', fontWeight: 700}}>{timer} sn</span>
  </div>
  
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span role="img" aria-label="repeat" style={{ fontSize: '1.1rem' }}>üîÅ</span> 
    <span>Tur:</span> <b>{currentStoryIndex + 1} / 3</b>
  </div>
  
  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
    <span role="img" aria-label="heart" style={{ fontSize: '1.1rem' }}>üí™</span> 
    <span>Hak</span> <b>{Math.max(0, DIFFICULTY_SETTINGS[difficulty].tries - tries)}</b>
          </div>
          </div>

          </div>
    </div>
  );
}

export default DailyChallenge; 